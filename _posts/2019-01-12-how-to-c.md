---
title: 从HTTP下载器看C语言编程关键
date: 2019-01-15 22:50:00
categories:
- 编程基础
tags:
- C
- Programming
---

# 从HTTP下载器看C语言编程关键

## 一些废话

要成为一名合格的软件工程师，就不能在工作中受限于编程语言。但是，作为一个C语言新手，大量的指针用法、不常使用的库函数，以及没有面向对象的概念还有和操作系统紧密相连的特性，让我的编程效率大大降低。因此我希望通过这篇博文记录一些C语言编程时的关键点，便于以后复习回忆。

本学期，我选修了一门网络编程课，虽然内容不深，但是以编程实践为导向。要求使用C或者C++，做系统层面的网络编程。我可以趁此机会，一方面好好的做一些C语言实战，另外可以熟悉Linux网络编程，并且好好学习一下gdb的用法。

第一次作业虽然不难，但是我只是对socket在理论层面有所认知，并没有时间经验，参考了很多网上别人的博客，基于别人的代码熟悉了socket编程的基本套路，然后开始实践。但是，语言层面的生疏还是让我进展缓慢，于是记录下这个热身用的第一次作业的实现和改进过程，重点关注编程语言层面的暴露出来的问题，日后回顾起来也会方便很多。

学习一门语言，并不是简单的学习循环怎么写，变量怎么声明。作为一个有其他编程经验的程序员，关键是找到这个新语言的最特别的特质、并且主动了解该语言在使用背后的思想，这样才能以最快速度学习到一门新的编程语言。同时，只有大量实践，才能有自信说自己“会”这门语言而不会被问倒。

## 程序设计思路

这个程序的目的是要实现wget的下载功能。输入url，可以正确的开始HTTP下载。为了简化问题，老师让我们在url之前输入IP地址，这样程序就不需要进行DNS解析。或者，在url地址之后添加"-h"标志符，则不需要进行下载而只是获取HTTP response部首。

基于这个要求，该程序从逻辑上分成了三段：

    1. 正确获取用户输入；
    2. 根据用户输入生成HTTP请求头部，同时生成socket套接字，并且根据IP地址将请求通过socket发送给服务器；
    3. 正确解析服务器返回值，如果能够下载则下载并且保存至硬盘。

这三部分功能在书写时对C的运用侧重点各不相同。第一部分主要是对argv和argc的调用，以及c语言对字符串的处理。第二部分侧重socket生成和使用，以及ip_addr在内存层面的初始化和socket的绑定。第三部分则主要是本地文件的生成、修改和保存，顺便可能会碰到一些数据结构在C中的实现。

## 本文核心：C语言使用时容易遗忘、混淆和发生错误的地方

### C语言不一样的地方

第一是没有面向对象（OOP）。这大概是作为从java入门计算机学科的同学最苦恼的问题之一了。没有对象，意味着程序员需要时刻记住自己正在处理计算机的内存。因此，需要的任何东西都需要手动开辟内存空间，并且用完之后要销毁。同时，除了基本的数值赋值，其他所有的等号要时刻牢记要么是地址的拷贝，要么用库函数或者自己实现对内存的深拷贝（特别是strcpy）。

第二，一个函数实现多个返回值。这个问题在比如python一类可以多返回值的编程语言里自然是不存在的。但是，我认为这个问题在诸如java一类的语言里也不存在。理由是：java是纯粹的面向对象，因此用对象的观点去”操作对象“，根本不需要返回。某些需要返回的函数，其实是一个流程的中间件，操作一个对象，自然只能吐出一个对象来，剩下其他运算生产出来的副产品要么保存在对象中，要么通过其他的设计模式传送到其他对象里去，因为这个函数本身也一定运行在某一个对象之中，操作这些值就是操作`this`。而在C中，一个常见的做法是，如果需要多返回，那么索性就不返回或者只返回一个简单的数，真正需要返回的东西**在函数调用之前初始化内存**，然后在函数声明的位置添加若干需要返回的值的形式参数，**把要返回的值当作参数**传入函数，在函数内部改变对应内存的内容。这里特别需要提醒，在函数使用的时候，传入的参数应当是需要返回的**指针的内存**，而不是指针。

第三，由于和操作系统编程紧密结合，很多库函数会值返回一个简单的int值。这些值可不能简单的理解为整数。在Linux中，万物皆文件。这些返回的整数应当理解为程序所在的用户进程对这个文件的文件描述符，即该进程内部对这个文件的标示符，也即下标。所以，通过这个整数，其实是可以操作到这个“文件”的。为啥要加双引号呢？因为这里所说的文件不是人类语言中的文件，而是一个Linux文件，它有可能是任何文件或者硬件甚至是一个抽象概念的具体表示。举个例子，在本文的这个程序中，`socket()`函数初始化出来的一个具体的套接字在程序里就是用一个整数表示，如果他是负数，那么说明在初始化的时候发生了错误；这也是为什么这个整数被我们习惯性的命名为`fb`（file desriptor的缩写）。

我在该程序的实现中比较会犯错，不太熟悉的基本就是以上三点。如果发现有其他特别需要重视的知识点，以后在行文补充。

### C语言的调用

这个比较坑，虽然不难，但是特别容易忘记。特别是长期不写的话。

```bash
gcc ./mycode.c -o excutableprogram
```

当然这一行也可以写到makefile里，再直接调用make。

### 常用库的使用

`#include <stdio.h>` 简单的来说，就是用到这里面的`printf()`。也有关于文件的读写，方法前面加`f`。
`#include <stdlib.h>` 简单的说，就是用到了内存相关的操作，诸如`malloc()`和`free()`。
`#include <string.h>` 特别提醒我自己，这个库包含和所有和字符串有关的操作，特别是一些容易遗忘的方法比如`strcpy()`。
`#include <sys/socket.h>` 不用多说，socket相关方法都在这里。
`#include <unistd.h>` 这个需要强调的是，在这里和socket相关方法配合使用。当socket已经被建立的时候，之前已经说过，对于程序员来说，就要像读写一般文件一样读写这个socket即可，那么这个lib就是在提供标准的文件读写方法，比如`write()`和`read()`。当然这只是针对TCP来说。另外有一对其他的方法可以替换这两个方法，效果完全一样。
`include <arpa/inet.h>` 这个也是和socket库一同出现的。在socket通信的时候，必须有一个相应的IP地址和其绑定。这个库就在提供这个IP地址的结构体声明`stuct sockaddr_in addr`。

### 指针

这个真的是C语言最重要的易错点，也是常考的考点。中文网络环境下对这个问题的理解大多又臭又长，虽说可能面面俱到，但是最后也只是让你的书签栏多一个收藏或者是你真的用到的时候临时改到能用为止。那么，我来提出一个简单的具有统一性的记忆方法，因为除了C，其实很多很新的语言也有指针这个概念，比如Go，会用指针真的很重要。
基本的记忆规则就是：首先判断一个指针到底是用在声明还是使用。声明，包括函数头里的形式参数变量的声明和函数体里变量声明。一个声明的指针是先看变量名的，读取变量名以后，看这个变量名右边有什么，如果有就先和这个名字结合，然后看左边，从右往左结合，看这个指针到底是什么。这样的阅读符合计算机的习惯，可以准确的识别这个指针变量。其次是使用。使用的时候就是拿这个指针出来，如果直接用，那就是这个指针变量里保存的值，也就是一个内存地址，如果加上`*`或者`[]`那就是这个内存地址指向的东西。

### 内存使用

我觉得这个部分的重要性和指针一样。毕竟，指针不就是为了指向内存嘛;)
有几个常见的，先熟悉他们怎么用就好。其他的等有了一定的编码经验以后再说。
`malloc` 给一个新声明的变量分配一块新的内存。
`ralloc` 给一个已经有内存的变量追加一块内存。
`memset` 把刚分配出去的内存里的东西清空。

### String库函数的常见用法

这里就提常见的几个，其他的用的时候随时学就好了。
`strstr` 查找子串
`strcmp` 比较字符串
`strcpy` 复制字符串的内存内容
`strtok` 分割字符串
还有一个不在字符串库但是也常见的：把string转化到int：`atoi()` (在`stdlib.h`里)

## 总结

本文只是想表达通过这个程序如何对C语言编程有基本的认知，目的并不是要表述如何用C写socket程序。所有有关socket的具体用法并没有在这里表述。相关的内容在网上泛滥成灾，写的比我好的大有人在，我不想浪费我或者读者的时间。这里只贴出我写的客户端程序的[github链接](https://github.com/changsheng-liu/CMPE156_NetworkProgramming)。打不开是因为这个学期还在进行。等到学期结束就会把仓库变为公有。