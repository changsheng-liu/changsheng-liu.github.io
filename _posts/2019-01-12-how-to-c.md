# 从HTTP下载器看C语言编程关键

## 一些废话

要成为一名合格的软件工程师，就不能在工作中受限于编程语言。但是，作为一个C语言新手，大量的指针用法、不常使用的库函数，以及没有面向对象的概念还有和操作系统紧密相连的特性，让我的编程效率大大降低。因此我希望通过这篇博文记录一些C语言编程时的关键点，便于以后复习回忆。

本学期，我选修了一门网络编程课，虽然内容不深，但是以编程实践为导向。要求使用C或者C++，做系统层面的网络编程。我可以趁此机会，一方面好好的做一些C语言实战，另外可以熟悉Linux网络编程，并且好好学习一下gdb的用法。

第一次作业虽然不难，但是我只是对socket在理论层面有所认知，并没有时间经验，参考了很多网上别人的博客，基于别人的代码熟悉了socket编程的基本套路，然后开始实践。但是，语言层面的生疏还是让我进展缓慢，于是记录下这个热身用的第一次作业的实现和改进过程，重点关注编程语言层面的暴露出来的问题，日后回顾起来也会方便很多。

学习一门语言，并不是简单的学习循环怎么写，变量怎么声明。作为一个有其他编程经验的程序员，关键是找到这个新语言的最特别的特质、并且主动了解该语言在使用背后的思想，这样才能以最快速度学习到一门新的编程语言。同时，只有大量实践，才能有自信说自己“会”这门语言而不会被问倒。

## 程序设计思路

这个程序的目的是要实现wget的下载功能。输入url，可以正确的开始HTTP下载。为了简化问题，老师让我们在url之前输入IP地址，这样程序就不需要进行DNS解析。或者，在url地址之后添加"-h"标志符，则不需要进行下载而只是获取HTTP response部首。

基于这个要求，该程序从逻辑上分成了三段：

    1. 正确获取用户输入；
    2. 根据用户输入生成HTTP请求头部，同时生成socket套接字，并且根据IP地址将请求通过socket发送给服务器；
    3. 正确解析服务器返回值，如果能够下载则下载并且保存至硬盘。

这三部分功能在书写时对C的运用侧重点各不相同。第一部分主要是对argv和argc的调用，以及c语言对字符串的处理。第二部分侧重socket生成和使用，以及ip_addr在内存层面的初始化和socket的绑定。第三部分则主要是本地文件的生成、修改和保存，顺便可能会碰到一些数据结构在C中的实现。

## 本文核心：C语言使用时容易遗忘、混淆和发生错误的地方

### C语言不一样的地方

第一是没有面向对象（OOP）。这大概是作为从java入门计算机学科的同学最苦恼的问题之一了。没有对象，意味着程序员需要时刻记住自己正在处理计算机的内存。因此，需要的任何东西都需要手动开辟内存空间，并且用完之后要销毁。同时，除了基本的数值赋值，其他所有的等号要时刻牢记要么是地址的拷贝，要么用库函数或者自己实现对内存的深拷贝（特别是strcpy）。

第二，一个函数实现多个返回值。这个问题在比如python一类可以多返回值的编程语言里自然是不存在的。但是，我认为这个问题在诸如java一类的语言里也不存在。理由是：java是纯粹的面向对象，因此用对象的观点去”操作对象“，根本不需要返回。某些需要返回的函数，其实是一个流程的中间件，操作一个对象，自然只能吐出一个对象来，剩下其他运算生产出来的副产品要么保存在对象中，要么通过其他的设计模式传送到其他对象里去，因为这个函数本身也一定运行在某一个对象之中，操作这些值就是操作`this`。而在C中，一个常见的做法是，如果需要多返回，那么索性就不返回或者只返回一个简单的数，真正需要返回的东西**在函数调用之前初始化内存**，然后在函数声明的位置添加若干需要返回的值的形式参数，**把要返回的值当作参数**传入函数，在函数内部改变对应内存的内容。这里特别需要提醒，在函数使用的时候，传入的参数应当是需要返回的**指针的内存**，而不是指针。

第三，由于和操作系统编程紧密结合，很多库函数会值返回一个简单的int值。这些值可不能简单的理解为整数。在Linux中，万物皆文件。这些返回的整数应当理解为程序所在的用户进程对这个文件的文件描述符，即该进程内部对这个文件的标示符，也即下标。所以，通过这个整数，其实是可以操作到这个“文件”的。为啥要加双引号呢？因为这里所说的文件不是人类语言中的文件，而是一个Linux文件，它有可能是任何文件或者硬件甚至是一个抽象概念的具体表示。举个例子，在本文的这个程序中，`socket()`函数初始化出来的一个具体的套接字在程序里就是用一个整数表示，如果他是负数，那么说明在初始化的时候发生了错误；这也是为什么这个整数被我们习惯性的命名为`fb`（file desriptor的缩写）。

我在该程序的实现中比较会犯错，不太熟悉的基本就是以上三点。如果发现有其他特别需要重视的知识点，以后在行文补充。

### C语言的调用

这个比较坑，虽然不难，但是特别容易忘记。特别是长期不写的话。

```bash
gcc ./mycode.c -o excutableprogram
```

当然这一行也可以写到makefile里，再直接调用make。

### 常用库的使用

`#include <stdio.h>` 简单的来说，就是用到这里面的`printf()`。
`#include <stdlib.h>` 简单的说，就是用到了内存相关的操作，诸如`malloc()`和`free()`。
`#include <string.h>` 特别提醒我自己，这个库包含和所有和字符串有关的操作，特别是一些容易遗忘的方法比如`strcpy()`。
`#include <sys/socket.h>` 不用多说，socket相关方法都在这里。

### 指针

这个真的是C语言最重要的易错点，也是常考的考点。

### String库函数的常见用法